# MVCC, vacuum и autovacuum

**После изменения параметров, запуск pgbench показал, что:**
 1. Уменьшилось количество фактически обработанных транзакций с 34868 до 34397 а все потому что..см.ниже
 2. Увеличилось время соединения каждой транзакции с 35.548 ms до 38.024 ms
 3. Уменьшилось количество обработанных транзакций в секунду с 5,81 до 5,73.

**Возможно повлияло то, что:**

1. Effective_cache_size предоставляет оценку памяти, доступной для кэширования диска. Данный параметр был уменьшен с 4Gb до 3Gb.
2.  Default_statistics_target был увеличен в пять раз.
Чем больше установленное значение, тем больше времени требуется для выполнения ANALYZE.

*После того, как мы создали таблицу, заполнили её случайными данными в размере 1млн строк, выключили autovacuum и начали обновлять все строки - размер таблицы значительно увеличивался с каждым обновлением.  А также увеличивалось количество мертвых строк. Неиспользуемые мертвые строки занимают место в памяти и на диске, а также значительно влияют на производительность. Для этого и необходим процесс autovacuum. 
**Автоматическая очистка (autovacuum)** — как раз тот самый механизм, который позволяет запускать очистку в зависимости от активности изменений в таблицах.
Процесс очистки autovacuum, или команда VACUUM, пробегает по изменённым страницам и помечает такое место как свободное, после чего новые записи могут спокойно записываться в это место, при этом размер файла таблицы физически не уменьшается.
Чтобы максимально уменьшить таблицу в PostgreSQL есть VACUUM FULL или CLUSTER, но оба эти способа требуют  **exclusively locks**  на таблицу (блокируют доступ к таблице на время работы, то есть в это время с таблицы нельзя ни читать, ни писать), что далеко не всегда является подходящим решением.
    В принципе процедура очистки, autovacuum или VACUUM, все же может сама уменьшить размер таблицы убрав полностью пустые страницы, но только при условии что они находятся в самом конце таблицы.
    Сборку мусора безусловно делать необходимо, чтобы таблицы не разрастались и эффективно использовали дисковое пространство, но внезапно начавшийся данный процесс даст дополнительную нагрузку на диск и таблицы, что приведёт к увеличению времени выполнения запросов.*

**Вывод: 
Autovacuum не влияет на физический размер объекта, даже после своей работы. На самом деле autovacuum полностью отключить нельзя — даже при autovacuum = off иногда (после большого количества транзакций) autovacuum будет запускаться.
Отключать autovacuum крайне не рекомендуется, иначе имеет смысл самостоятельно запланировать регулярное выполнение команды VACUUM ANALYZE.**